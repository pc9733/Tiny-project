name: Deploy to EC2 (Nginx)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure SSH (write key + known_hosts)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config

      - name: Sync site files to EC2 (/tmp)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y rsync
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_ed25519" \
            ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/mywebsite/

      - name: Move into Nginx root and reload
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'EOF'
          set -e
          # Ensure Nginx + rsync exist (first run safety)
          if ! command -v nginx >/dev/null 2>&1; then
            sudo dnf install -y nginx
            sudo systemctl enable --now nginx
          fi
          if ! command -v rsync >/dev/null 2>&1; then
            sudo dnf install -y rsync
          fi

          # Ensure web root exists
          sudo mkdir -p /var/www/mywebsite

          # Deploy files
          sudo rsync -av --delete /tmp/mywebsite/ /var/www/mywebsite/
          sudo chown -R nginx:nginx /var/www/mywebsite

          # Minimal Nginx site config (idempotent)
          if [ ! -f /etc/nginx/conf.d/mywebsite.conf ]; then
            sudo tee /etc/nginx/conf.d/mywebsite.conf >/dev/null <<'CONF'
            server {
                listen 80;
                server_name _;
                root /var/www/mywebsite;
                index index.html;

                access_log /var/log/nginx/mywebsite.access.log;
                error_log  /var/log/nginx/mywebsite.error.log;

                location / {
                    try_files $uri $uri/ =404;
                }
            }
            CONF
                      fi

                      # Validate and reload Nginx
                      sudo nginx -t
                      sudo systemctl reload nginx
            EOF

