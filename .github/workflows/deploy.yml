name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.EC2_HOST }}
      USER: ${{ secrets.EC2_USER }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sanity check inputs (no secrets printed)
        run: |
          [ -n "${HOST}" ] && echo "HOST set ✅" || (echo "HOST missing ❌" && exit 1)
          [ -n "${USER}" ] && echo "USER set ✅" || (echo "USER missing ❌" && exit 1)

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config

      - name: Install rsync on runner
        run: |
          sudo apt-get update -y
          sudo apt-get install -y rsync

      - name: Test SSH connectivity
        run: |
          ssh -i ~/.ssh/id_ed25519 -o BatchMode=yes -o ConnectTimeout=10 ${USER}@${HOST} "echo 'SSH OK on ' \$(hostname)"

      - name: Sync site files to EC2 (/tmp)
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_ed25519" \
            ./ \
            ${USER}@${HOST}:/tmp/mywebsite/

      - name: Install deps, move into Nginx root, reload
        run: |
          ssh -i ~/.ssh/id_ed25519 ${USER}@${HOST} <<'EOF'
          set -euo pipefail
          # Ensure required packages on EC2
          if ! command -v nginx >/dev/null 2>&1; then
            sudo dnf update -y
            sudo dnf install -y nginx
            sudo systemctl enable --now nginx
          fi
          if ! command -v rsync >/dev/null 2>&1; then
            sudo dnf install -y rsync
          fi

          # Deploy
          sudo mkdir -p /var/www/mywebsite
          sudo rsync -av --delete /tmp/mywebsite/ /var/www/mywebsite/
          sudo chown -R nginx:nginx /var/www/mywebsite

          # Idempotent Nginx config (root points to /var/www/mywebsite)
          if [ ! -f /etc/nginx/conf.d/mywebsite.conf ]; then
            sudo tee /etc/nginx/conf.d/mywebsite.conf >/dev/null <<CONF
            server {
              listen 80;
              server_name _;
              root /var/www/mywebsite;
              index index.html;
              access_log /var/log/nginx/mywebsite.access.log;
              error_log  /var/log/nginx/mywebsite.error.log;
              location / { try_files \$uri \$uri/ =404; }
            }
CONF
          fi

          sudo nginx -t
          sudo systemctl reload nginx
          EOF

