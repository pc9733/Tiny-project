name: Deploy to EC2 (Nginx)

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: "Branch to run against"
        type: choice
        options:
          - main
          - develop
        default: main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Tiny-project

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Derive version
        id: version
        run: |
          VERSION="$(cat VERSION 2>/dev/null || echo 0.0.0)"
          echo "value=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Build release tarball
        run: |
          set -euo pipefail
          mkdir -p dist
          tar czf "dist/companies-app-${{ steps.version.outputs.value }}.tar.gz" \
            --exclude ".git" \
            --exclude "dist" \
            --exclude ".github" \
            .

      - name: Configure SSH (write key + known_hosts)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config

      - name: Sync site files to EC2 (/tmp)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y rsync
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_ed25519" \
            ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/mywebsite/
          scp -i ~/.ssh/id_ed25519 dist/companies-app-${{ steps.version.outputs.value }}.tar.gz \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/

      - name: Move into Nginx root and reload
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'EOF'
          set -e
          if ! command -v nginx >/dev/null 2>&1; then
            sudo dnf install -y nginx
            sudo systemctl enable --now nginx
          fi
          if ! command -v rsync >/dev/null 2>&1; then
            sudo dnf install -y rsync
          fi
          sudo mkdir -p /var/www/mywebsite
          sudo rsync -av --delete /tmp/mywebsite/ /var/www/mywebsite/
          sudo chown -R nginx:nginx /var/www/mywebsite
          sudo tee /etc/nginx/conf.d/mywebsite.conf >/dev/null <<'CONF'
          server {
              listen 80;
              server_name _;
              root /var/www/mywebsite;
              index index.html;
              access_log /var/log/nginx/mywebsite.access.log;
              error_log  /var/log/nginx/mywebsite.error.log;

              location / {
                  try_files $uri $uri/ =404;
              }

              location /api/ {
                  proxy_pass http://127.0.0.1:8000;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_redirect off;
              }
          }
          CONF
          sudo nginx -t
          sudo systemctl reload nginx
          EOF
 # --- Backend: sync to /home/ec2-user/companies-api and (re)start service ---
      - name: Sync backend
        if: hashFiles('backend/**') != ''
        run: |
          rsync -avz -e "ssh -i ~/.ssh/id_ed25519" \
            backend/ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ec2-user/companies-api-sync/

      - name: Install backend deps + restart service
        if: hashFiles('backend/**') != ''
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'EOS'
          set -e
          # materialize working dir
          mkdir -p ~/companies-api
          rsync -av --delete ~/companies-api-sync/ ~/companies-api/

          # python venv
          if [ ! -d ~/companies-api/venv ]; then
            python3 -m venv ~/companies-api/venv
          fi
          source ~/companies-api/venv/bin/activate
          pip install --upgrade pip
          pip install -r ~/companies-api/requirements.txt

          # install/refresh systemd unit
          sudo cp ~/companies-api/companies-api.service /etc/systemd/system/companies-api.service
          sudo systemctl daemon-reload
          sudo systemctl enable --now companies-api || sudo systemctl restart companies-api
          EOS
